# 엔드투엔드 테스트 시나리오

## 테스트 환경 준비

1. Xcode에서 프로젝트 열기
2. 시뮬레이터 또는 실제 기기에서 실행
3. API 키가 Keychain에 저장되어 있는지 확인

## 테스트 시나리오

### 시나리오 1: 기본 채팅 기능

**목표**: 기본 메시지 송수신 및 저장 기능 검증

**단계**:
1. 앱 실행
2. 빈 채팅 화면 확인 (환영 메시지 표시)
3. "안녕하세요" 입력 후 전송
4. AI 응답 수신 확인
5. 앱 종료 후 재실행
6. 이전 대화 복원 확인

**예상 결과**:
- ✅ 메시지가 즉시 표시됨
- ✅ AI 응답이 5초 이내 수신됨
- ✅ 앱 재시작 후 모든 메시지 복원됨
- ✅ 로딩 인디케이터 표시됨

---

### 시나리오 2: 브랜치 기능

**목표**: 브랜치 질문 생성 및 네비게이션 검증

**단계**:
1. 기본 대화 2-3턴 진행
2. AI 응답에 "더 물어보기" 버튼 확인
3. "더 물어보기" 버튼 클릭
4. 브랜치 질문 입력 (예: "이 부분에 대해 더 자세히 설명해주세요")
5. 브랜치 응답 확인
6. 브랜치 인디케이터 확인 ("브랜치: N개 메시지" 표시)
7. "메인으로 돌아가기" 버튼 클릭
8. 메인 브랜치로 복귀 확인

**예상 결과**:
- ✅ "더 물어보기" 버튼이 AI 메시지에만 표시됨
- ✅ 브랜치 질문 입력 UI 표시됨
- ✅ 브랜치 응답이 올바르게 생성됨
- ✅ 브랜치 인디케이터가 표시됨
- ✅ 메인으로 복귀 시 메인 브랜치 메시지만 표시됨

---

### 시나리오 3: 삭제 및 Undo 기능

**목표**: 메시지 삭제 및 복원 기능 검증

**단계**:
1. 여러 메시지가 있는 대화 상태
2. 메시지 길게 누르기
3. 삭제 확인 다이얼로그 확인
4. "삭제" 선택
5. Undo 토스트 확인 (3초간 표시)
6. "실행 취소" 버튼 클릭
7. 메시지 복원 확인
8. 다시 삭제 후 3초 대기
9. 토스트 자동 사라짐 확인

**예상 결과**:
- ✅ 삭제 확인 다이얼로그 표시됨
- ✅ 삭제 시 하위 브랜치도 함께 삭제됨
- ✅ Undo 토스트가 표시됨
- ✅ Undo로 메시지 복원 가능
- ✅ 3초 후 토스트 자동 사라짐

---

### 시나리오 4: 백그라운드 관리

**목표**: 백그라운드 정보 추출 및 활용 검증

**단계**:
1. 대화 5턴 이상 진행
2. 백그라운드 업데이트 대기 (5턴마다 자동 업데이트)
3. 새로운 질문에서 이전 대화 맥락 언급 확인
4. 설정 화면에서 백그라운드 확인 (디버그용)

**예상 결과**:
- ✅ 5턴마다 백그라운드 자동 업데이트됨
- ✅ AI 응답이 이전 대화 맥락을 기억함
- ✅ 백그라운드 정보가 API 호출 시 포함됨

---

### 시나리오 5: 컨텍스트 최적화

**목표**: 긴 대화에서 컨텍스트 최적화 검증

**단계**:
1. 매우 긴 대화 진행 (토큰 수가 임계치 초과하도록)
2. 컨텍스트 최적화 자동 실행 확인
3. 오래된 메시지 요약 생성 확인
4. 최근 메시지는 원문 유지 확인

**예상 결과**:
- ✅ 토큰 수가 임계치 초과 시 자동 요약 생성
- ✅ 최근 10턴은 원문 유지
- ✅ 오래된 메시지는 요약으로 대체
- ✅ AI 응답 품질 유지

---

### 시나리오 6: 네트워크 오류 처리

**목표**: 네트워크 오류 상황 처리 검증

**단계**:
1. 비행기 모드 활성화
2. 메시지 전송 시도
3. 네트워크 오류 메시지 확인
4. 비행기 모드 해제
5. 메시지 재전송
6. 정상 응답 수신 확인

**예상 결과**:
- ✅ 오프라인 상태에서 적절한 에러 메시지 표시
- ✅ 네트워크 복구 후 재시도 가능
- ✅ 사용자 친화적 에러 메시지

---

### 시나리오 7: Rate Limit 처리

**목표**: API Rate Limit 재시도 로직 검증

**단계**:
1. 빠르게 여러 메시지 연속 전송
2. Rate Limit 발생 시나리오 (실제로는 어려울 수 있음)
3. 자동 재시도 확인 (exponential backoff)
4. 최종 성공 또는 에러 메시지 확인

**예상 결과**:
- ✅ Rate Limit 발생 시 자동 재시도 (최대 3회)
- ✅ Exponential backoff 적용
- ✅ 재시도 실패 시 사용자에게 알림

---

### 시나리오 8: 브랜치 엣지 케이스

**목표**: 브랜치 관련 엣지 케이스 검증

**단계**:
1. 루트 메시지에서 브랜치 생성
2. 브랜치에서 브랜치 생성 (중첩 브랜치)
3. 깊은 브랜치 생성 (5단계 이상)
4. 브랜치에서 메인으로 복귀
5. 다시 다른 브랜치 생성

**예상 결과**:
- ✅ 모든 브랜치 시나리오에서 정상 작동
- ✅ 브랜치 경로가 올바르게 계산됨
- ✅ 컨텍스트가 올바르게 필터링됨

---

### 시나리오 9: 삭제 엣지 케이스

**목표**: 삭제 관련 엣지 케이스 검증

**단계**:
1. 루트 메시지 삭제
2. 모든 메시지 삭제
3. 삭제 후 즉시 새 메시지 입력
4. Undo 후 재삭제
5. 브랜치가 있는 메시지 삭제

**예상 결과**:
- ✅ 모든 삭제 시나리오에서 정상 작동
- ✅ 하위 브랜치도 함께 삭제됨
- ✅ 백그라운드 롤백 정상 작동

---

### 시나리오 10: UI/UX 검증

**목표**: 사용자 경험 및 UI 검증

**단계**:
1. 다크 모드 전환 확인
2. 다양한 화면 크기에서 테스트
3. 스크롤 동작 확인
4. 애니메이션 확인
5. 접근성 기능 확인 (VoiceOver)

**예상 결과**:
- ✅ 다크 모드에서도 정상 표시
- ✅ 다양한 화면 크기에서 레이아웃 유지
- ✅ 부드러운 스크롤 및 애니메이션
- ✅ 접근성 레이블이 올바르게 설정됨

---

## 자동화된 검증 체크리스트

### 기능 검증
- [ ] 단일 세션 유지
- [ ] 메시지 저장 및 복원
- [ ] 백그라운드 업데이트
- [ ] 브랜치 생성 및 네비게이션
- [ ] 삭제 및 Undo
- [ ] 컨텍스트 최적화

### 기술적 검증
- [ ] API 호출 정상 작동
- [ ] 에러 처리 적절함
- [ ] 데이터베이스 CRUD 정상
- [ ] 컨텍스트 빌더 정상 작동
- [ ] 로깅 정상 작동

### 성능 검증
- [ ] API 응답 시간 < 5초
- [ ] UI 업데이트 즉시 반영
- [ ] 메모리 누수 없음
- [ ] 대량 메시지에서도 안정적

---

## 빌드 및 배포 체크리스트

### 빌드 전 확인
- [ ] 모든 파일 컴파일 성공
- [ ] 경고 없음 (또는 허용 가능한 경고만)
- [ ] 린터 오류 없음
- [ ] 의존성 정상 설치

### 빌드 실행
```bash
# 시뮬레이터 빌드
xcodebuild -project personal-mind-coach.xcodeproj \
  -scheme personal-mind-coach \
  -sdk iphonesimulator \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  clean build

# 실제 기기 빌드 (서명 필요)
xcodebuild -project personal-mind-coach.xcodeproj \
  -scheme personal-mind-coach \
  -sdk iphoneos \
  -configuration Release \
  clean build
```

### 배포 전 확인
- [ ] 버전 번호 업데이트
- [ ] 빌드 번호 증가
- [ ] API 키 Keychain 저장 확인
- [ ] 프라이버시 정책 확인

### TestFlight 배포 (선택)
```bash
# Fastlane 사용 시
fastlane beta

# 또는 Xcode에서 직접 업로드
```

---

## 로그 확인 방법

### Xcode 콘솔에서 확인할 로그
- API 요청/응답 로그 (📤 📥)
- 토큰 사용량 (📊)
- 백그라운드 업데이트 로그
- 에러 로그 (❌)

### 로그 필터링
Xcode 콘솔에서 다음으로 필터링:
- `API`: API 관련 로그
- `Database`: 데이터베이스 관련 로그
- `Background`: 백그라운드 관련 로그
- `Branch`: 브랜치 관련 로그

---

## 알려진 제한사항

1. **Xcode 필요**: 현재 시스템에 Xcode 앱이 설치되어 있지 않아 빌드 불가
   - 해결: Xcode 앱 설치 후 `xcode-select --switch /Applications/Xcode.app/Contents/Developer` 실행

2. **API 키**: 기본 API 키가 코드에 포함되어 있음
   - 해결: Keychain에 저장하도록 사용자 안내 필요

3. **시뮬레이터**: 실제 기기 테스트 권장
   - 네트워크 테스트
   - 성능 테스트
   - 실제 사용자 경험

---

## 다음 단계

1. Xcode 설치 및 빌드 환경 구성
2. 시뮬레이터에서 기본 기능 테스트
3. 실제 기기에서 전체 시나리오 테스트
4. 성능 프로파일링 (Instruments)
5. TestFlight 베타 테스트 (선택)
